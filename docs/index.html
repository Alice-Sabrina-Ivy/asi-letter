<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="color-scheme" content="light dark">
  <title>ASI Letter — v2025.09.14</title>
  <style>
    :root{
      --w:900px; --pad-x:24px; --lh:1.7;
      --bg:#f6f7f9; --text:#0b0f19; --muted:#475569; --border:#e5e7eb;
      --link:#0969da; --code-bg:#f6f8fa; --code-border:#d0d7de;
    }
    @media (prefers-color-scheme: dark){
      :root{
        --bg:#0b0f19; --text:#c9d1d9; --muted:#9aa4b2; --border:#30363d;
        --link:#58a6ff; --code-bg:#0d1117; --code-border:#30363d;
      }
    }
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font:16px/var(--lh) ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Apple Color Emoji","Segoe UI Emoji";
      -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
    }
    .container{max-width:var(--w); margin:40px auto; padding:0 var(--pad-x);}
    .markdown-body{word-wrap:break-word;}
    .markdown-body h1,.markdown-body h2{
      border-bottom:1px solid var(--border); padding-bottom:.3em; margin:24px 0 16px; line-height:1.25;
    }
    .markdown-body h1{font-size:2em}
    .markdown-body h2{font-size:1.5em}
    .markdown-body h3{font-size:1.25em; margin:20px 0 12px}
    .markdown-body p,.markdown-body ul,.markdown-body ol,.markdown-body blockquote,.markdown-body pre,.markdown-body table{margin:16px 0}
    .markdown-body ul,.markdown-body ol{padding-left:2em}
    .markdown-body a{color:var(--link); text-decoration:none}
    .markdown-body a:hover{text-decoration:underline}
    .markdown-body blockquote{border-left:.25em solid var(--border); padding:0 1em; color:var(--muted)}
    .markdown-body code{
      font:.95rem/1.6 ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
      background:var(--code-bg); border:1px solid var(--code-border); border-radius:6px; padding:.15em .35em;
    }
    .markdown-body pre{background:var(--code-bg); border:1px solid var(--code-border); border-radius:6px; padding:16px; overflow:auto}
    .markdown-body pre code{background:transparent; border:0; padding:0; font-size:.9rem; line-height:1.6}
    .markdown-body hr{height:1px; border:0; background:var(--border)}
    .markdown-body table{border-collapse:collapse; width:100%}
    .markdown-body table th,.markdown-body table td{border:1px solid var(--border); padding:.5rem; vertical-align:top}

    /* Signature styling */
    .signature{margin-top:32px; padding-top:16px; border-top:1px solid var(--border)}
    .signature p{margin:4px 0}
    .signature .pronouns{color:var(--muted)}

    /* Compact variant via ?v=compact6 */
    body[data-variant^="compact"] .container{max-width:760px}
    body[data-variant^="compact"] .markdown-body{line-height:1.65}
    body[data-variant^="compact"] .markdown-body h1{font-size:1.65rem}
    body[data-variant^="compact"] .markdown-body h2{font-size:1.25rem}

    @media (max-width:640px){.container{margin:24px auto}}
    .loading{color:var(--muted); font-style:italic}
    .error{color:#b91c1c}
  </style>
</head>
<body>
  <main class="container">
    <article class="markdown-body">
      <div id="md" class="loading">Loading letter…</div>

      <!-- Hidden canonical signature; shown only if none detected in content -->
      <footer class="signature" id="canonical-signature" style="display:none">
        <p>Until we meet—</p>
        <p>Alice Sabrina Ivy</p>
        <p class="pronouns">she/her</p>
      </footer>

      <noscript>
        <p class="error">JavaScript is required to render the letter. You can read it directly in <a href="https://github.com/Alice-Sabrina-Ivy/asi-letter/blob/main/docs/letter.md" rel="noopener">docs/letter.md</a>.</p>
      </noscript>
    </article>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js" defer></script>
  <script>
    (function(){
      const v = new URLSearchParams(location.search).get("v");
      if (v) document.body.dataset.variant = v;

      const mdEl = document.getElementById('md');
      const fallbackSig = document.getElementById('canonical-signature');

      // ---------- helpers ----------
      const isLikelyHTML = (txt) => /^\s*<(!doctype|html|head|body)[\s>]/i.test(txt);
      const norm = (s) => s
        .replace(/\u00A0/g, ' ')       // NBSP -> space
        .replace(/[—–-]/g, '-')        // unify dashes
        .replace(/\s+/g, ' ')          // collapse spaces
        .trim()
        .toLowerCase();

      function decodeBase64Utf8(b64){
        const bin = atob(b64.replace(/\n/g,''));
        const bytes = new Uint8Array(bin.length);
        for (let i=0;i<bin.length;i++) bytes[i] = bin.charCodeAt(i);
        return new TextDecoder('utf-8').decode(bytes);
      }

      function makeFooter(){
        const footer = document.createElement('footer');
        footer.className = 'signature';
        footer.innerHTML = `
          <p>Until we meet—</p>
          <p>Alice Sabrina Ivy</p>
          <p class="pronouns">she/her</p>`;
        return footer;
      }

      // Find and normalize signature in rendered HTML.
      function ensureSingleSignature(container){
        let found = false;

        // 1) Look for a single <p> that contains everything on one line (mojibake-safe).
        const ps = Array.from(container.querySelectorAll('p'));
        for (const p of ps){
          const t = norm(p.textContent);
          if (/^until we meet-?\s+alice sabrina ivy(\s+she\/her)?$/.test(t)){
            p.replaceWith(makeFooter());
            found = true;
            break;
          }
        }

        // 2) Look for three consecutive <p> lines: "Until we meet—", "Alice Sabrina Ivy", "she/her".
        if (!found){
          const pAll = Array.from(container.querySelectorAll('p'));
          for (let i=0; i < pAll.length - 2; i++){
            const t0 = norm(pAll[i].textContent);
            const t1 = norm(pAll[i+1].textContent);
            const t2 = norm(pAll[i+2].textContent);
            const looksStart = t0 === 'until we meet' || t0 === 'until we meet-' ;
            if (looksStart && t1 === 'alice sabrina ivy' && (t2 === 'she/her' || t2 === 'she / her')){
              pAll[i].replaceWith(makeFooter());
              pAll[i+1].remove();
              pAll[i+2].remove();
              found = true;
              break;
            }
          }
        }

        // 3) If not found but the end of the text clearly has the signature even without <p> splits,
        //    detect it in the trailing text and append standardized footer once.
        if (!found){
          const tail = norm(container.innerText).slice(-240); // last chunk
          if (tail.includes('until we meet- alice sabrina ivy she/her') ||
              (tail.includes('until we meet') && tail.includes('alice sabrina ivy') && tail.includes('she/her'))){
            container.appendChild(makeFooter());
            found = true;
          }
        }

        // 4) If still not found, show fallback signature from the HTML.
        if (!found){
          fallbackSig.style.display = 'block';
        }else{
          // Remove any extra signatures that might exist.
          const sigs = container.querySelectorAll('.signature');
          if (sigs.length > 1){
            for (let i=0; i<sigs.length-1; i++) sigs[i].remove();
          }
          fallbackSig.remove(); // not needed
        }
      }

      function renderMarkdown(text){
        const html = window.marked.parse(text, { mangle:false, headerIds:true });
        mdEl.innerHTML = html;
        mdEl.querySelectorAll('a[href^="http"]').forEach(a => { a.rel='noopener'; a.target='_blank'; });
        ensureSingleSignature(mdEl);
      }

      async function fetchText(url){
        const r = await fetch(url, { cache:'no-cache' });
        if (!r.ok) throw new Error(r.status + ' ' + r.statusText);
        return await r.text();
      }

      async function fetchGithubContentsAPI(){
        const url = 'https://api.github.com/repos/Alice-Sabrina-Ivy/asi-letter/contents/docs/letter.md?ref=main';
        const r = await fetch(url, { headers: { 'Accept':'application/vnd.github+json' }, cache:'no-cache' });
        if (!r.ok) throw new Error('GitHub API: ' + r.status);
        const j = await r.json();
        if (j && j.encoding === 'base64' && j.content){
          return decodeBase64Utf8(j.content);
        }
        throw new Error('GitHub API: unexpected response');
      }

      async function load(){
        if (!window.marked) return setTimeout(load, 15);

        const tries = [
          fetchGithubContentsAPI,
          () => fetchText('https://cdn.jsdelivr.net/gh/Alice-Sabrina-Ivy/asi-letter@main/docs/letter.md'),
          () => fetchText('https://raw.githubusercontent.com/Alice-Sabrina-Ivy/asi-letter/main/docs/letter.md'),
          () => fetchText('./docs/letter.md')
        ];

        for (const attempt of tries){
          try{
            const text = typeof attempt === 'function' ? await attempt() : await fetchText(attempt);
            mdEl.classList.remove('loading');
            if (isLikelyHTML(text)){
              mdEl.innerHTML = text;                 // pre-rendered HTML fallback
              ensureSingleSignature(mdEl);
            }else{
              renderMarkdown(text);
            }
            return;
          }catch(e){ /* try next */ }
        }

        mdEl.classList.remove('loading');
        mdEl.innerHTML = `
          <p class="error">Could not load <code>docs/letter.md</code>.</p>
          <p>Open it on GitHub: <a href="https://github.com/Alice-Sabrina-Ivy/asi-letter/blob/main/docs/letter.md" rel="noopener" target="_blank">docs/letter.md</a></p>
        `;
      }

      load();
    })();
  </script>
</body>
</html>
