<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="color-scheme" content="light dark">
  <title>ASI Letter — v2025.09.14</title>
  <style>
    :root{
      --w:900px; --pad-x:24px; --lh:1.7;
      --bg:#f6f7f9; --text:#0b0f19; --muted:#475569; --border:#e5e7eb;
      --link:#0969da; --code-bg:#f6f8fa; --code-border:#d0d7de;
    }
    @media (prefers-color-scheme: dark){
      :root{
        --bg:#0b0f19; --text:#c9d1d9; --muted:#9aa4b2; --border:#30363d;
        --link:#58a6ff; --code-bg:#0d1117; --code-border:#30363d;
      }
    }
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font:16px/var(--lh) ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Apple Color Emoji","Segoe UI Emoji";
      -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
    }
    .container{max-width:var(--w); margin:40px auto; padding:0 var(--pad-x);}
    .markdown-body{word-wrap:break-word;}
    .markdown-body h1,.markdown-body h2{
      border-bottom:1px solid var(--border); padding-bottom:.3em; margin:24px 0 16px; line-height:1.25;
    }
    .markdown-body h1{font-size:2em}
    .markdown-body h2{font-size:1.5em}
    .markdown-body h3{font-size:1.25em; margin:20px 0 12px}
    .markdown-body p,.markdown-body ul,.markdown-body ol,.markdown-body blockquote,.markdown-body pre,.markdown-body table{margin:16px 0}
    .markdown-body ul,.markdown-body ol{padding-left:2em}
    .markdown-body a{color:var(--link); text-decoration:none}
    .markdown-body a:hover{text-decoration:underline}
    .markdown-body blockquote{border-left:.25em solid var(--border); padding:0 1em; color:var(--muted)}
    .markdown-body code{
      font:.95rem/1.6 ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
      background:var(--code-bg); border:1px solid var(--code-border); border-radius:6px; padding:.15em .35em;
    }
    .markdown-body pre{background:var(--code-bg); border:1px solid var(--code-border); border-radius:6px; padding:16px; overflow:auto}
    .markdown-body pre code{background:transparent; border:0; padding:0; font-size:.9rem; line-height:1.6}
    .markdown-body hr{height:1px; border:0; background:var(--border)}
    .markdown-body table{border-collapse:collapse; width:100%}
    .markdown-body table th,.markdown-body table td{border:1px solid var(--border); padding:.5rem; vertical-align:top}

    /* Normalized signature style (applied after render) */
    .signature{margin-top:32px; padding-top:16px; border-top:1px solid var(--border)}
    .signature p{margin:4px 0}
    .signature .pronouns{color:var(--muted)}

    /* Compact variant via ?v=compact5 */
    body[data-variant^="compact"] .container{max-width:760px}
    body[data-variant^="compact"] .markdown-body{line-height:1.65}
    body[data-variant^="compact"] .markdown-body h1{font-size:1.65rem}
    body[data-variant^="compact"] .markdown-body h2{font-size:1.25rem}

    @media (max-width:640px){.container{margin:24px auto}}
    .loading{color:var(--muted); font-style:italic}
    .error{color:#b91c1c}
  </style>
</head>
<body>
  <main class="container">
    <article class="markdown-body">
      <div id="md" class="loading">Loading letter…</div>
      <noscript>
        <p class="error">JavaScript is required to render the letter. You can read it directly in <a href="https://github.com/Alice-Sabrina-Ivy/asi-letter/blob/main/docs/letter.md" rel="noopener">docs/letter.md</a>.</p>
      </noscript>
    </article>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js" defer></script>
  <script>
    (function(){
      const v = new URLSearchParams(location.search).get("v");
      if (v) document.body.dataset.variant = v;

      const mdEl = document.getElementById('md');

      // --- Helpers ---
      const isLikelyHTML = (txt) => /^\s*<(!doctype|html|head|body)[\s>]/i.test(txt);
      const collapse = (s) => s.replace(/\s+/g,' ').trim().toLowerCase();

      function decodeBase64Utf8(b64){
        const bin = atob(b64.replace(/\n/g,''));
        const bytes = new Uint8Array(bin.length);
        for (let i=0;i<bin.length;i++) bytes[i] = bin.charCodeAt(i);
        return new TextDecoder('utf-8').decode(bytes);
      }

      // Normalize any inline signature into a single 3-line footer
      function normalizeSignatureInHTML(container){
        const oneLineRe = /^until we meet(?:\s*(?:—|–|-|â))?\s+alice\s+sabrina\s+ivy(?:\s+she\/her)?$/i;

        // 1) Convert 1-line signature paragraph into 3-line footer
        const ps = Array.from(container.querySelectorAll('p'));
        for (const p of ps){
          if (oneLineRe.test(collapse(p.textContent))){
            const footer = document.createElement('footer');
            footer.className = 'signature';
            footer.innerHTML = `
              <p>Until we meet—</p>
              <p>Alice Sabrina Ivy</p>
              <p class="pronouns">she/her</p>`;
            p.replaceWith(footer);
            break; // assume only one needed
          }
        }

        // 2) If three consecutive paragraphs form the signature, wrap them once
        const pAll = Array.from(container.querySelectorAll('p'));
        for (let i=0; i < pAll.length - 2; i++){
          const t0 = collapse(pAll[i].textContent);
          const t1 = collapse(pAll[i+1].textContent);
          const t2 = collapse(pAll[i+2].textContent);
          const looksStart = /^until we meet(?:\s*(?:—|–|-|â))?$/.test(t0);
          if (looksStart && t1 === 'alice sabrina ivy' && (t2 === 'she/her' || t2 === 'she / her')){
            const footer = document.createElement('footer');
            footer.className = 'signature';
            footer.innerHTML = `
              <p>Until we meet—</p>
              <p>Alice Sabrina Ivy</p>
              <p class="pronouns">she/her</p>`;
            pAll[i].replaceWith(footer);
            pAll[i+1].remove();
            pAll[i+2].remove();
            break;
          }
        }

        // 3) De-duplicate: if multiple .signature exist, keep the last one
        const sigs = container.querySelectorAll('.signature');
        if (sigs.length > 1){
          for (let i=0;i<sigs.length-1;i++) sigs[i].remove();
        }
      }

      function renderMarkdown(text){
        const html = window.marked.parse(text, { mangle:false, headerIds:true });
        mdEl.innerHTML = html;
        // External links
        mdEl.querySelectorAll('a[href^="http"]').forEach(a => { a.rel='noopener'; a.target='_blank'; });
        normalizeSignatureInHTML(mdEl);
      }

      async function fetchGithubContentsAPI(){
        const url = 'https://api.github.com/repos/Alice-Sabrina-Ivy/asi-letter/contents/docs/letter.md?ref=main';
        const r = await fetch(url, { headers: { 'Accept':'application/vnd.github+json' }, cache:'no-cache' });
        if (!r.ok) throw new Error('GitHub API: ' + r.status);
        const j = await r.json();
        if (j && j.encoding === 'base64' && j.content){
          return decodeBase64Utf8(j.content);
        }
        throw new Error('GitHub API: unexpected response');
      }

      async function fetchText(url){
        const r = await fetch(url, { cache:'no-cache' });
        if (!r.ok) throw new Error(r.status + ' ' + r.statusText);
        return await r.text();
      }

      async function load(){
        if (!window.marked) return setTimeout(load, 15);

        const tries = [
          fetchGithubContentsAPI,
          () => fetchText('https://cdn.jsdelivr.net/gh/Alice-Sabrina-Ivy/asi-letter@main/docs/letter.md'),
          () => fetchText('https://raw.githubusercontent.com/Alice-Sabrina-Ivy/asi-letter/main/docs/letter.md'),
          () => fetchText('./docs/letter.md')
        ];

        for (const attempt of tries){
          try{
            const text = typeof attempt === 'function' ? await attempt() : await fetchText(attempt);
            mdEl.classList.remove('loading');
            if (isLikelyHTML(text)){
              mdEl.innerHTML = text;                 // fallback: pre-rendered HTML
              normalizeSignatureInHTML(mdEl);        // still normalize/remove dupes
            }else{
              renderMarkdown(text);                   // Markdown → HTML + normalize
            }
            return;
          }catch(e){ /* try next */ }
        }

        mdEl.classList.remove('loading');
        mdEl.innerHTML = `
          <p class="error">Could not load <code>docs/letter.md</code>.</p>
          <p>Open it on GitHub: <a href="https://github.com/Alice-Sabrina-Ivy/asi-letter/blob/main/docs/letter.md" rel="noopener" target="_blank">docs/letter.md</a></p>
        `;
      }

      load();
    })();
  </script>
</body>
</html>
