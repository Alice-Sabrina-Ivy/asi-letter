<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="color-scheme" content="light dark">
  <title>ASI Letter — v2025.09.14</title>
  <style>
    :root{
      --w:900px; --pad-x:24px; --lh:1.7;
      --bg:#f6f7f9; --text:#0b0f19; --muted:#475569; --border:#e5e7eb;
      --link:#0969da; --code-bg:#f6f8fa; --code-border:#d0d7de;

      /* Buttons */
      --btn-bg:#ffffff; --btn-border:#e5e7eb; --btn-hover:rgba(0,0,0,.04);
      --btn-text: var(--text);
      --btn-primary-bg: var(--link); --btn-primary-text:#0b1020;
    }
    @media (prefers-color-scheme: dark){
      :root{
        --bg:#0b0f19; --text:#c9d1d9; --muted:#9aa4b2; --border:#30363d;
        --link:#58a6ff; --code-bg:#0d1117; --code-border:#30363d;

        --btn-bg:#111827; --btn-border:#374151; --btn-hover:rgba(255,255,255,.06);
        --btn-text: var(--text);
        --btn-primary-bg: var(--link); --btn-primary-text:#0b1020;
      }
    }

    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font:16px/var(--lh) ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Apple Color Emoji","Segoe UI Emoji";
      -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
    }

    .container{max-width:var(--w); margin:40px auto; padding:0 var(--pad-x);}
    .markdown-body{word-wrap:break-word;}

    .markdown-body h1,.markdown-body h2{
      border-bottom:1px solid var(--border); padding-bottom:.3em; margin:24px 0 16px; line-height:1.25;
    }
    .markdown-body h1{font-size:2em}
    .markdown-body h2{font-size:1.5em}
    .markdown-body h3{font-size:1.25em; margin:20px 0 12px}

    .markdown-body p,.markdown-body ul,.markdown-body ol,.markdown-body blockquote,.markdown-body pre,.markdown-body table{margin:16px 0}
    .markdown-body ul,.markdown-body ol{padding-left:2em}
    .markdown-body a{color:var(--link); text-decoration:none}
    .markdown-body a:hover{text-decoration:underline}

    .markdown-body blockquote{border-left:.25em solid var(--border); padding:0 1em; color:var(--muted)}
    .markdown-body code{
      font:.95rem/1.6 ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
      background:var(--code-bg); border:1px solid var(--code-border); border-radius:6px; padding:.15em .35em;
    }
    .markdown-body pre{background:var(--code-bg); border:1px solid var(--code-border); border-radius:6px; padding:16px; overflow:auto}
    .markdown-body pre code{background:transparent; border:0; padding:0; font-size:.9rem; line-height:1.6}
    .markdown-body hr{height:1px; border:0; background:var(--border)}
    .markdown-body table{border-collapse:collapse; width:100%}
    .markdown-body table th,.markdown-body table td{border:1px solid var(--border); padding:.5rem; vertical-align:top}

    /* Signature */
    .signature{margin-top:32px; padding-top:16px; border-top:1px solid var(--border)}
    .signature p{margin:4px 0}
    .signature .pronouns{color:var(--muted)}

    /* CTA Button Bar */
    .cta-bar{
      display:flex; flex-wrap:wrap; align-items:center; gap:12px;
      margin-top:20px;
    }
    .btn{
      display:inline-flex; align-items:center; gap:.55rem;
      padding:.6rem .95rem; border-radius:9999px; border:1px solid var(--btn-border);
      background:var(--btn-bg); color:var(--btn-text); text-decoration:none; font-weight:500;
      box-shadow:0 1px 0 rgba(0,0,0,.05);
      transition:transform .04s ease-out, box-shadow .12s ease-out, background .12s ease-out, color .12s ease-out;
      line-height:1;
    }
    /* Ensure button color beats generic .markdown-body a styles */
    .markdown-body a.btn,
    .markdown-body a.btn:link,
    .markdown-body a.btn:visited{ color:var(--btn-text) !important; text-decoration:none }

    .btn:hover{ background:var(--btn-hover); text-decoration:none; transform:translateY(-1px); box-shadow:0 6px 16px rgba(0,0,0,.12) }
    .btn:active{ transform:translateY(0); box-shadow:none }
    .btn svg{ width:1.05em; height:1.05em; fill:currentColor }

    .btn-primary{
      background:var(--btn-primary-bg); color:var(--btn-primary-text); border-color:transparent;
    }
    .markdown-body a.btn.btn-primary,
    .markdown-body a.btn.btn-primary:link,
    .markdown-body a.btn.btn-primary:visited{ color:var(--btn-primary-text) !important; }

    .btn-primary:hover{ filter:brightness(0.95) }

    /* Variant */
    body[data-variant^="compact"] .container{max-width:760px}
    body[data-variant^="compact"] .markdown-body{line-height:1.65}
    body[data-variant^="compact"] .markdown-body h1{font-size:1.65rem}
    body[data-variant^="compact"] .markdown-body h2{font-size:1.25rem}

    @media (max-width:640px){.container{margin:24px auto}}

    .loading{color:var(--muted); font-style:italic}
    .error{color:#b91c1c}
  </style>
</head>
<body>
  <main class="container">
    <article class="markdown-body">
      <div id="md" class="loading">Loading letter…</div>

      <!-- Hidden canonical signature; shown only if none detected -->
      <footer class="signature" id="canonical-signature" style="display:none">
        <p>Until we meet—</p>
        <p>Alice Sabrina Ivy</p>
        <p class="pronouns">she/her</p>
      </footer>

      <!-- CTA bar -->
      <nav class="cta-bar" id="cta-bar" hidden>
        <a class="btn btn-primary" id="btn-repo" href="https://github.com/Alice-Sabrina-Ivy/asi-letter" target="_blank" rel="noopener" aria-label="Open repository on GitHub">
          <!-- GitHub mark -->
          <svg viewBox="0 0 16 16" aria-hidden="true"><path d="M8 0C3.58 0 0 3.64 0 8.13c0 3.6 2.29 6.65 5.47 7.73.4.08.55-.18.55-.39 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.5-2.69-.96-.09-.23-.48-.96-.82-1.15-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.53.28-.87.51-1.07-1.78-.2-3.64-.91-3.64-4.05 0-.9.31-1.64.82-2.22-.08-.2-.36-1.02.08-2.12 0 0 .67-.22 2.2.85.64-.18 1.33-.27 2.01-.27.68 0 1.37.09 2.01.27 1.53-1.07 2.2-.85 2.2-.85.44 1.1.16 1.92.08 2.12.51.58.82 1.32.82 2.22 0 3.15-1.87 3.85-3.65 4.05.29.26.54.77.54 1.55 0 1.12-.01 2.03-.01 2.31 0 .21.15.47.55.39A8.06 8.06 0 0 0 16 8.13C16 3.64 12.42 0 8 0Z" fill="currentColor"/></svg>
          <span>Canonical source</span>
        </a>

        <a class="btn" id="btn-letter" href="https://github.com/Alice-Sabrina-Ivy/asi-letter/blob/main/docs/letter.md" target="_blank" rel="noopener">
          <!-- Document icon -->
          <svg viewBox="0 0 16 16" aria-hidden="true"><path d="M4 1h5l4 4v10a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1Zm5 1.5V5h3.5L9 2.5ZM5 7h6v1.5H5V7Zm0 3h6v1.5H5V10Z" fill="currentColor"/></svg>
          <span>Open letter.md</span>
        </a>

        <a class="btn" id="btn-verify" href="https://github.com/Alice-Sabrina-Ivy/asi-letter/commits/main" target="_blank" rel="noopener" title="View commit signatures on GitHub">
          <!-- Shield-check icon -->
          <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 2l7 3v6c0 5-3.1 9.4-7 11-3.9-1.6-7-6-7-11V5l7-3zm0 2.2L7 5.2v5.5c0 4.1 2.6 7.9 5 9.2 2.4-1.3 5-5.1 5-9.2V5.2l-5-1zm4.3 5.6l-5 5a1 1 0 0 1-1.4 0l-2-2 1.4-1.4 1.3 1.3 4.3-4.3 1.4 1.4z" fill="currentColor"/></svg>
          <span>Verify signature</span>
        </a>
      </nav>

      <noscript>
        <p class="error">JavaScript is required to render the letter. You can read it directly in <a href="https://github.com/Alice-Sabrina-Ivy/asi-letter/blob/main/docs/letter.md" rel="noopener">docs/letter.md</a>.</p>
      </noscript>
    </article>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js" defer></script>
  <script>
    (function(){
      const v = new URLSearchParams(location.search).get("v");
      if (v) document.body.dataset.variant = v;

      const mdEl = document.getElementById('md');
      const fallbackSig = document.getElementById('canonical-signature');
      const ctaBar = document.getElementById('cta-bar');

      const REPO = 'https://github.com/Alice-Sabrina-Ivy/asi-letter';
      const LETTER = REPO + '/blob/main/docs/letter.md';

      const isLikelyHTML = (txt) => /^\s*<(!doctype|html|head|body)[\s>]/i.test(txt);
      const norm = (s) => s.replace(/\u00A0/g,' ').replace(/[—–-]/g,'-').replace(/\s+/g,' ').trim().toLowerCase();

      function decodeBase64Utf8(b64){
        const bin = atob(b64.replace(/\n/g,''));
        const bytes = new Uint8Array(bin.length);
        for (let i=0;i<bin.length;i++) bytes[i] = bin.charCodeAt(i);
        return new TextDecoder('utf-8').decode(bytes);
      }

      function makeFooter(){
        const footer = document.createElement('footer');
        footer.className = 'signature';
        footer.innerHTML = `
          <p>Until we meet—</p>
          <p>Alice Sabrina Ivy</p>
          <p class="pronouns">she/her</p>`;
        return footer;
      }

      function ensureSingleSignature(container){
        let found = false;
        for (const p of container.querySelectorAll('p')){
          const t = norm(p.textContent);
          if (/^until we meet-?\s+alice sabrina ivy(\s+she\/her)?$/.test(t)){
            p.replaceWith(makeFooter()); found = true; break;
          }
        }
        if (!found){
          const all = Array.from(container.querySelectorAll('p'));
          for (let i=0;i<all.length-2;i++){
            const t0=norm(all[i].textContent), t1=norm(all[i+1].textContent), t2=norm(all[i+2].textContent);
            if ((t0==='until we meet'||t0==='until we meet-') && t1==='alice sabrina ivy' && (t2==='she/her'||t2==='she / her')){
              all[i].replaceWith(makeFooter()); all[i+1].remove(); all[i+2].remove(); found = true; break;
            }
          }
        }
        if (!found){
          const tail = norm(container.innerText).slice(-240);
          if (tail.includes('until we meet- alice sabrina ivy she/her') ||
              (tail.includes('until we meet') && tail.includes('alice sabrina ivy') && tail.includes('she/her'))){
            container.appendChild(makeFooter()); found = true;
          }
        }
        if (!found){ fallbackSig.style.display='block'; }
        else { const sigs = container.querySelectorAll('.signature'); if (sigs.length>1){ for(let i=0;i<sigs.length-1;i++) sigs[i].remove(); } fallbackSig.remove(); }
      }

      function removeCanonicalParagraph(container){
        const paras = Array.from(container.querySelectorAll('p'));
        for (const p of paras){
          const t = p.textContent.trim();
          if (/^canonical source\s*:/i.test(t)) { p.remove(); continue; }
          const a = p.querySelector('a[href]');
          if (a && (a.getAttribute('href')===REPO || a.href===REPO)) { p.remove(); }
        }
      }

      function placeCTA(container){
        ctaBar.hidden = false;
        document.getElementById('btn-repo').href = REPO;
        document.getElementById('btn-letter').href = LETTER;
        const sig = container.querySelector('.signature');
        if (sig) sig.insertAdjacentElement('afterend', ctaBar);
        else container.appendChild(ctaBar);
      }

      function renderMarkdown(text){
        const html = window.marked.parse(text, { mangle:false, headerIds:true });
        mdEl.innerHTML = html;
        mdEl.querySelectorAll('a[href^="http"]').forEach(a => { a.rel='noopener'; a.target='_blank'; });
        ensureSingleSignature(mdEl);
        removeCanonicalParagraph(mdEl);
        placeCTA(mdEl);
      }

      async function fetchText(url){
        const r = await fetch(url, { cache:'no-cache' });
        if (!r.ok) throw new Error(r.status + ' ' + r.statusText);
        return await r.text();
      }

      async function fetchGithubContentsAPI(){
        const url = REPO.replace('https://github.com/','https://api.github.com/repos/') + '/contents/docs/letter.md?ref=main';
        const r = await fetch(url, { headers: { 'Accept':'application/vnd.github+json' }, cache:'no-cache' });
        if (!r.ok) throw new Error('GitHub API: ' + r.status);
        const j = await r.json();
        if (j && j.encoding === 'base64' && j.content){ return decodeBase64Utf8(j.content); }
        throw new Error('GitHub API: unexpected response');
      }

      async function load(){
        if (!window.marked) return setTimeout(load, 15);
        const tries = [
          fetchGithubContentsAPI,
          () => fetchText('https://cdn.jsdelivr.net/gh/Alice-Sabrina-Ivy/asi-letter@main/docs/letter.md'),
          () => fetchText('https://raw.githubusercontent.com/Alice-Sabrina-Ivy/asi-letter/main/docs/letter.md'),
          () => fetchText('./docs/letter.md')
        ];
        for (const attempt of tries){
          try{
            const text = typeof attempt === 'function' ? await attempt() : await fetchText(attempt);
            mdEl.classList.remove('loading');
            if (isLikelyHTML(text)){ mdEl.innerHTML = text; ensureSingleSignature(mdEl); removeCanonicalParagraph(mdEl); placeCTA(mdEl); }
            else { renderMarkdown(text); }
            return;
          }catch(e){ /* try next */ }
        }
        mdEl.classList.remove('loading');
        mdEl.innerHTML = `
          <p class="error">Could not load <code>docs/letter.md</code>.</p>
          <p>Open it on GitHub: <a href="${LETTER}" rel="noopener" target="_blank">docs/letter.md</a></p>
        `;
        placeCTA(mdEl);
      }

      load();
    })();
  </script>
</body>
</html>
