name: ots-stamp-letter-asc
on:
  push:
    paths:
      - 'letter/*.asc'
  workflow_dispatch: {}

concurrency:
  group: letter-artifacts-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: write
  actions: read

jobs:
  stamp-letter-asc:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install OpenTimestamps client
        run: python -m pip install --upgrade opentimestamps-client

      - name: Stamp any new .asc in /letter (idempotent)
        id: stamp
        shell: bash
        run: |
          set -euo pipefail
          shopt -s nullglob
          touched=0
          for asc in letter/*.asc; do
            otsfile="${asc}.ots"
            if [[ ! -f "$otsfile" ]]; then
              echo "Stamping $asc -> $otsfile"
              # creates "$asc.ots" in-place (no move needed)
              ots stamp "$asc"
              touched=1
            else
              echo "Exists: $otsfile (skipping)"
            fi
          done
          echo "touched=$touched" >> "$GITHUB_OUTPUT"

      - name: Rebase onto latest ${{ github.ref_name }} before pushing proofs
        if: steps.stamp.outputs.touched == '1'
        shell: bash
        run: |
          set -euo pipefail
          branch="${GITHUB_REF##*/}"
          git fetch origin "$branch"
          git pull --rebase --autostash origin "$branch"

      - name: Wait for GitHub Pages to be idle
        if: steps.stamp.outputs.touched == '1'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: .github/scripts/wait_for_pages_idle.sh

      - uses: stefanzweifel/git-auto-commit-action@v5
        if: steps.stamp.outputs.touched == '1'
        with:
          commit_message: "chore(ots): add proofs for new /letter/*.asc (auto)"
          file_pattern: letter/*.asc.ots
